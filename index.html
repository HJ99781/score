<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>학생 성적 관리</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            width: 100%;
            padding: 2rem;
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.1);
        }
        .message-box {
            position: fixed;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4b5563;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            z-index: 1000;
            display: none;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background-color: #f9fafb;
            font-weight: 600;
            color: #1f2937;
        }
    </style>
</head>
<body>

<div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[2000]">
    <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
</div>

<div id="loginPage" class="container">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">로그인</h1>
    <div class="space-y-4">
        <input type="email" id="loginEmail" placeholder="이메일" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
        <input type="password" id="loginPassword" placeholder="비밀번호" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200">
        <button id="loginBtn" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-200">로그인</button>
        <button id="registerBtn" class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-green-700 transition duration-200">회원가입</button>
    </div>
</div>

<div id="mainApp" class="container hidden">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">학생 성적 관리</h1>
        <div class="flex items-center space-x-4">
            <span id="userEmailDisplay" class="text-gray-600 font-medium"></span>
            <button id="logoutBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-200">로그아웃</button>
        </div>
    </div>
    
    <div class="mb-6 space-y-4">
        <h2 class="text-xl font-bold text-gray-700">엑셀 성적 업로드</h2>
        <p class="text-gray-500">엑셀 양식을 다운받아 성적을 입력하고 업로드하세요.</p>
        <div class="flex flex-col space-y-2 md:space-y-0 md:flex-row md:space-x-2">
            <button id="downloadFormBtn" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 transition duration-200">양식 다운로드</button>
            <input type="file" id="excelFile" accept=".xlsx, .xls" class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none">
            <button id="uploadBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-200">업로드</button>
        </div>
    </div>

    <div class="overflow-x-auto rounded-lg shadow-md">
        <table id="scoreTable">
            <thead>
                <tr>
                    <th class="py-3 px-6 text-xs font-medium tracking-wider text-gray-500 uppercase">이름</th>
                    <th class="py-3 px-6 text-xs font-medium tracking-wider text-gray-500 uppercase">국어</th>
                    <th class="py-3 px-6 text-xs font-medium tracking-wider text-gray-500 uppercase">수학</th>
                    <th class="py-3 px-6 text-xs font-medium tracking-wider text-gray-500 uppercase">영어</th>
                    <th class="py-3 px-6 text-xs font-medium tracking-wider text-gray-500 uppercase">사회</th>
                    <th class="py-3 px-6 text-xs font-medium tracking-wider text-gray-500 uppercase">과학</th>
                    <th class="py-3 px-6 text-xs font-medium tracking-wider text-gray-500 uppercase">평균</th>
                    <th class="py-3 px-6 text-xs font-medium tracking-wider text-gray-500 uppercase">동작</th>
                </tr>
            </thead>
            <tbody id="scoreTableBody" class="bg-white divide-y divide-gray-200">
                <!-- 성적 데이터가 여기에 표시됩니다. -->
            </tbody>
        </table>
    </div>
</div>

<div id="messageBox" class="message-box"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script type="module">
    // Firebase SDK 로드
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Firebase 설정 ---
    // Firebase 콘솔에서 복사한 firebaseConfig 객체를 여기에 붙여넣으세요.
    // 기존의 const firebaseConfig = JSON.parse(...) 부분은 삭제합니다.
    const firebaseConfig =  {
    apiKey: "AIzaSyClRLOmDay20rQ4F0eOWT64vKCgSBTuido",
    authDomain: "score-c7b85.firebaseapp.com",
    projectId: "score-c7b85",
    storageBucket: "score-c7b85.firebasestorage.app",
    messagingSenderId: "629818605979",
    appId: "1:629818605979:web:2e358040352ec3e739613e",
    measurementId: "G-YRTRDR4YQM"
  };
   const appId = "default-app-id"; // 원하는 앱 ID로 변경해도 됩니다.

   // Canvas 환경에서 제공하는 __app_id 변수를 사용합니다.
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const PUBLIC_DATA_PATH = `artifacts/${appId}/public/data`;

    // --- Firebase 초기화 ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- 전역 변수 ---
    let userEmail = null;
    let isAuthReady = false;

    // --- DOM 요소 선택 ---
    const userEmailDisplay = document.getElementById('userEmailDisplay');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loginPage = document.getElementById('loginPage');
    const mainApp = document.getElementById('mainApp');
    const messageBox = document.getElementById('messageBox');
    const excelFile = document.getElementById('excelFile');
    const scoreTableBody = document.getElementById('scoreTableBody');
    const uploadBtn = document.getElementById('uploadBtn');
    const downloadFormBtn = document.getElementById('downloadFormBtn');

    // --- 유틸리티 함수 ---
    function showMessage(message) {
        messageBox.textContent = message;
        messageBox.style.display = 'block';
        setTimeout(() => {
            messageBox.style.display = 'none';
        }, 3000);
    }

    function showLoading(show) {
        loadingOverlay.style.display = show ? 'flex' : 'none';
    }

    // --- 데이터 처리 함수 ---
    function processExcelFile(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                if (jsonData.length < 2) {
                    reject('엑셀 파일에 데이터가 없습니다.');
                    return;
                }
                const headers = jsonData[0];
                const requiredHeaders = ['이름', '국어', '수학', '영어', '사회', '과학'];
                const headerCheck = requiredHeaders.every(h => headers.includes(h));
                if (!headerCheck) {
                    reject('엑셀 파일 양식이 올바르지 않습니다. 양식을 다운로드하여 사용해주세요.');
                    return;
                }
                const students = jsonData.slice(1).filter(row => row.length > 0 && row[0] != null).map(row => {
                    const student = {};
                    headers.forEach((header, index) => {
                        student[header] = row[index];
                    });
                    return student;
                });
                resolve(students);
            };
            reader.onerror = (error) => reject(error);
            reader.readAsArrayBuffer(file);
        });
    }

    // --- Firestore 데이터 관리 ---
    async function saveScoresToFirestore(students) {
        if (!isAuthReady) {
            showMessage("로그인 상태를 확인 중입니다. 잠시 후 다시 시도해 주세요.");
            return;
        }

        const scoresCollectionRef = collection(db, `${PUBLIC_DATA_PATH}/scores`);
        
        try {
            await getDocs(scoresCollectionRef)
            .then((snapshot) => {
                const batch = db.batch();
                snapshot.docs.forEach((doc) => {
                    batch.delete(doc.ref);
                });
                return batch.commit();
            });
            
            const scoreDocs = students.map(student => {
                const studentId = student['이름'];
                const docRef = doc(scoresCollectionRef, studentId);
                const { '이름': studentName, ...scores } = student;
                const newScore = {
                    name: studentName,
                    ...Object.fromEntries(
                        Object.entries(scores).map(([key, value]) => [key, parseInt(value) || 0])
                    )
                };
                return setDoc(docRef, newScore);
            });
            await Promise.all(scoreDocs);
            showMessage("성적 업로드 완료!");
        } catch (error) {
            console.error("Firestore에 데이터 저장 중 오류 발생:", error);
            showMessage("데이터 저장 중 오류가 발생했습니다.");
        }
    }

    function renderScores(scores) {
        scoreTableBody.innerHTML = '';
        if (scores.length === 0) {
            scoreTableBody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500 py-4">성적 데이터가 없습니다.</td></tr>';
            return;
        }

        scores.forEach(score => {
            const row = document.createElement('tr');
            const total = (score.국어 || 0) + (score.수학 || 0) + (score.영어 || 0) + (score.사회 || 0) + (score.과학 || 0);
            const average = total / 5;

            row.innerHTML = `
                <td class="py-4 px-6 text-sm font-medium text-gray-900">${score.name}</td>
                <td class="py-4 px-6 text-sm text-gray-500">${score.국어 || 0}</td>
                <td class="py-4 px-6 text-sm text-gray-500">${score.수학 || 0}</td>
                <td class="py-4 px-6 text-sm text-gray-500">${score.영어 || 0}</td>
                <td class="py-4 px-6 text-sm text-gray-500">${score.사회 || 0}</td>
                <td class="py-4 px-6 text-sm text-gray-500">${score.과학 || 0}</td>
                <td class="py-4 px-6 text-sm text-gray-500 font-semibold">${average.toFixed(2)}</td>
                <td class="py-4 px-6 text-sm font-medium">
                    <button class="delete-btn bg-red-500 text-white p-1 rounded-md hover:bg-red-600 transition duration-200" data-name="${score.name}">삭제</button>
                </td>
            `;
            scoreTableBody.appendChild(row);
        });
    }

    function setupRealtimeListener() {
        const scoresCollectionRef = collection(db, `${PUBLIC_DATA_PATH}/scores`);
        onSnapshot(scoresCollectionRef, (snapshot) => {
            const scores = snapshot.docs.map(doc => doc.data());
            renderScores(scores);
        }, (error) => {
            console.error("실시간 업데이트 구독 실패:", error);
            showMessage("데이터를 가져오는 데 실패했습니다.");
        });
    }

    // --- 이벤트 핸들러 ---
    // 회원가입
    document.getElementById('registerBtn').addEventListener('click', async () => {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        if (!email || !password) {
            showMessage("이메일과 비밀번호를 입력해주세요.");
            return;
        }
        showLoading(true);
        try {
            await createUserWithEmailAndPassword(auth, email, password);
            showMessage("회원가입 성공!");
        } catch (error) {
            console.error("회원가입 실패:", error.message);
            showMessage(`회원가입 실패: ${error.message}`);
        } finally {
            showLoading(false);
        }
    });

    // 로그인
    document.getElementById('loginBtn').addEventListener('click', async () => {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        if (!email || !password) {
            showMessage("이메일과 비밀번호를 입력해주세요.");
            return;
        }
        showLoading(true);
        try {
            await signInWithEmailAndPassword(auth, email, password);
            showMessage("로그인 성공!");
        } catch (error) {
            console.error("로그인 실패:", error.message);
            showMessage(`로그인 실패: ${error.message}`);
        } finally {
            showLoading(false);
        }
    });

    // 로그아웃
    document.getElementById('logoutBtn').addEventListener('click', async () => {
        await signOut(auth);
        showMessage("로그아웃 되었습니다.");
    });

    // 엑셀 업로드
    uploadBtn.addEventListener('click', async () => {
        if (!excelFile.files.length) {
            showMessage("엑셀 파일을 선택해주세요.");
            return;
        }
        showLoading(true);
        try {
            const students = await processExcelFile(excelFile.files[0]);
            await saveScoresToFirestore(students);
        } catch (error) {
            console.error(error);
            showMessage(`업로드 오류: ${error}`);
        } finally {
            showLoading(false);
        }
    });
    
    // 양식 다운로드
    downloadFormBtn.addEventListener('click', () => {
        const worksheet = XLSX.utils.aoa_to_sheet([['이름', '국어', '수학', '영어', '사회', '과학']]);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, '성적');
        XLSX.writeFile(workbook, '성적_양식.xlsx');
    });

    // 삭제 버튼
    scoreTableBody.addEventListener('click', async (e) => {
        if (e.target.classList.contains('delete-btn')) {
            const studentName = e.target.dataset.name;
            const scoresCollectionRef = collection(db, `${PUBLIC_DATA_PATH}/scores`);
            const q = query(scoresCollectionRef, where("name", "==", studentName));
            try {
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    const docRef = querySnapshot.docs[0].ref;
                    await setDoc(docRef, { name: '삭제된 학생' }); // Soft delete example
                    showMessage("학생 정보가 삭제되었습니다.");
                } else {
                    showMessage("해당 학생을 찾을 수 없습니다.");
                }
            } catch (error) {
                console.error("삭제 실패:", error);
                showMessage("삭제에 실패했습니다.");
            }
        }
    });

    // 인증 상태 변경 리스너
    onAuthStateChanged(auth, (user) => {
        isAuthReady = true;
        if (user) {
            userEmail = user.email;
            userEmailDisplay.textContent = userEmail || '익명 사용자';
            loginPage.classList.add('hidden');
            mainApp.classList.remove('hidden');
            setupRealtimeListener();
        } else {
            userEmail = null;
            loginPage.classList.remove('hidden');
            mainApp.classList.add('hidden');
        }
        showLoading(false);
    });

</script>
</body>
</html>


